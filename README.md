# ChatKit + OpenAI Agent Builder

A lightweight Express server that exposes the hosted `<openai-chatkit>` widget and nothing else—perfect for embedding the panel inside other tools while keeping session-token logic on the backend.

## Prerequisites

- Node.js 18+ (for native fetch and modern syntax)
- npm 9+

## Quick start

```sh
cp .env.example .env # optional, then edit AGENT_WORKFLOW_URL
npm install
npm run dev
```

Visit `http://localhost:3000` to see the ChatKit shell. Update `AGENT_WORKFLOW_URL` in `.env` (or export it in your shell) so the panel binds to the workflow you want to expose.

### Environment variables

- `AGENT_WORKFLOW_URL` – share link generated by OpenAI Agent Builder.
- `AGENT_WORKFLOW_PUBLIC_KEY` – optional `domain_pk_...` key that allows this server to talk to your workflow.
- `AGENT_WORKFLOW_ID` – optional override if you don’t want the ID inferred from the workflow URL.
- `OPENAI_API_KEY` – required when enabling server-side ChatKit sessions; should be a standard OpenAI API key with access to your workflow.
- `PUBLIC_BASE_URL` – override for the externally reachable origin. When unset, the server auto-detects Codespaces URLs (e.g., `https://$CODESPACE_NAME-$PORT.app.github.dev`), then falls back to `http://localhost:$PORT`.
- `PORT` – local port for the Express server (default `3000`).

## Environment variables

- `AGENT_WORKFLOW_URL` – Agent Builder share link used for the CTA in the hero + header actions inside ChatKit.
- `OPENAI_API_KEY` – API key used server-side to mint ChatKit session tokens. Never expose this to the browser.
- `CHATKIT_WORKFLOW_ID` – Workflow id (e.g., `wf_1234...`) targeted when creating ChatKit sessions via the OpenAI API.
- `PORT` – Optional override for the Express server port (defaults to `3000`).

## Scripts

- `npm run dev` – start the server with automatic reloads via nodemon.
- `npm run start` – run the production server.
- `npm run test` – lightweight configuration check used by CI.

## Project structure

```
server.js           # Express application + API endpoints
public/             # Static assets served by Express
  index.html        # Minimal ChatKit shell markup
  styles.css        # Styling for the full bleed panel
  app.js            # Fetches config + clipboard helper
```

## API surface

<<<<<<< HEAD
- `GET /api/config` returns the resolved `agentWorkflowUrl`, `agentWorkflowPublicKey`, and `publicBaseUrl` so the frontend can stay decoupled from secrets.
- `POST /api/chatkit-session` exchanges your `OPENAI_API_KEY` + workflow ID for a short-lived ChatKit `client_secret`, letting the browser start a session without ever seeing your API key.
=======
- `GET /api/config` returns the resolved `agentWorkflowUrl` so the frontend can stay decoupled from secrets.
- `POST /api/chatkit/session` accepts `{ deviceId }` and proxies ChatKit session creation via your OpenAI API key, returning a short-lived `token`.
>>>>>>> e44a1dcaba1b1d4ce3e1852450147d8dd0b896a7
- `GET /healthz` exposes a simple uptime probe for Docker/Kubernetes health checks.

## Running on a new Codespace URL

Codespaces assigns a new hostname every time you open a fresh container. Use the checklist below whenever the URL changes:

1. **Update `PUBLIC_BASE_URL`.** Set it to `https://$CODESPACE_NAME-$PORT.app.github.dev` so `/api/config` advertises the correct origin to the frontend.
2. **Choose your auth strategy:**

- _Session tokens (recommended):_ make sure `.env` contains `OPENAI_API_KEY` (and optionally `AGENT_WORKFLOW_ID`). The server will set `sessionApiEnabled: true`, the browser will call `/api/chatkit-session`, and no domain allowlist is required.
- _Domain key:_ if you prefer `AGENT_WORKFLOW_PUBLIC_KEY`, add the new Codespace host to the OpenAI domain allowlist and restart the server so the key is picked up.

3. **Restart the dev server.** `Ctrl+C` the existing `npm run dev`, then start it again so the new env vars load.
4. **Verify configuration.** Run `curl -s $PUBLIC_BASE_URL/api/config | jq` and confirm the URL, key details, and `sessionApiEnabled` flag look correct before sharing the link.

## Customization ideas

- Drop this shell into an `<iframe>` anywhere you need ChatKit access with consistent styling.
- Inject telemetry (e.g., PostHog, Segment) in `public/app.js` for click tracking.
- Extend `server.js` with additional routes that proxy or validate Agent Builder payloads before launching the workflow.
- Customize the embedded `<openai-chatkit>` widget in `public/app.js` with your own header actions, composer defaults, or tool callbacks. The widget script is loaded securely from `https://cdn.platform.openai.com/deployments/chatkit/chatkit.js`.
